---
title: "Analyzing multiplex imaging data using functional regression and wild bootstrap"
output: rmarkdown::html_vignette
bibliography: references.bib  
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this tutorial, we demonstrate the utilities of our package, *funboot,* for analyzing cell type colocalization in multiplex imaging data.  We apply functions from our package to a small data subset of imaging mass cytometry breast cancer data.

**Load package and dependencies**

```{r setup, error=FALSE, warning=FALSE, message=FALSE}
devtools::load_all('C:/Users/carly/Documents/funboot') 

#Dependencies for the analysis functions
library(spatstat.data)
library(spatstat.univar)
library(spatstat.geom)
library(spatstat.random)
library(spatstat.explore)
library(refund)
library(dplyr)

#Dependencies for the plotting functions
library(ggplot2)
library(patchwork)

```

**Disclaimer:**  This tutorial simply demonstrates how to user our functions, and we do not claim it to be a full analysis of data by which biological conclusions should be drawn.  We take several shortcuts in this tutorial in order to save computation time for the sake of demonstration (e.g., small number of bootstrap samples, only 10 images worth of data) that should not be used during a full data analysis.

## Breast Cancer Data

First, we will analyze a 10-image subset of the popular [Jackson Fischer breast cancer dataset](https://bodenmillergroup.github.io/imcdatasets/) [@jackson-fischer].  The subset is available within *funboot,* and it contains images 29, 30, 93, 104, 127, 164, 185, 224, 254, and 280 from the original dataset.  We load in the subset below:  

```{r fig.width = 7, fig.height = 12}
data("breastcancer_data_subset_10images")
```

Suppose we are interested in cell metaclusters 3 (T cells), 7 (Endothelial cells), 9 (Small circular stromal cells), and 16 (Proliferative epithelial cells).  Let's start by examining the cell distributions in each image, using the **plot_images()** function from *funboot.*

```{r fig.width = 7, fig.height = 12}
pallete <- c('Other' = "gray", '7' = 'gold', '3' = "darkgreen", '9' = 'skyblue', '16'='cyan4')
plot.list <- plot_images(data = breastcancer_data_subset_10images, images.to.plot = unique(breastcancer_data_subset_10images$image_number), cell.types.to.plot=c(7,3,9,16), pallete=pallete)

(plot.list[[1]] + plot.list[[2]])/
(plot.list[[3]] + plot.list[[4]])/
(plot.list[[5]] + plot.list[[6]])/
(plot.list[[7]] + plot.list[[8]])/
(plot.list[[9]] + plot.list[[10]])

```

In the original publication of the breast cancer dataset, cell types 7 and 3 are observed to be colocalized.  We can confirm this observation by fitting the concurrent functional regression model   

$$
\hat{L}_{iEndo,T}(r) - r = \beta_0(r) + \epsilon_i(r)
$$

and performing inference on the intercept $\beta_0(r)$.  The first step is to preprocess the raw data and calculate the appropriate spatial summary function, applying the necessary permutation adjustment and quality control cell count cutoff [@wilson; @spaceanova].  This can be carried out using our function **preprocess_data():**


```{r }
sumfun.data <- preprocess_data(data=breastcancer_data_subset_10images, from.cell=7, to.cell=3,
                               qc.cellcount.cutoff=20, P=50, perm.yn=T,
                               R=200, inc=1, image.dims=c(0,1000,0,1000),
                               summary.function='L',seed=456)

```
We fit the model using our function **fit_model()**, and examine the output:

```{r }
model <- fit_model(formula=outcome ~ 1, data=sumfun.data)
summary(model)

```
Both the constant intercept and smooth intercept from the output are positive; this is indicative of cell type interaction.  We calculate the wild bootstrap confidence band of both intercepts using **wildBS_CB()** and **plot.wildBS_CB(),** overlaying their respective pointwise confidence intervals.  

```{r fig.width = 6, fig.height = 3}
CBs <- wildBS_CB(formula=outcome ~ 1, data=sumfun.data,re='patient_id',
                 B=10,alpha=.05,seed=456)
#Plot CBs
plot.wildBS_CB(CBs)

```

Because neither confidence band crosses zero, the conclusion from this demonstration would be that the interaction is not significant. (However, note that the full dataset and many more bootstrap samples are needed for accurate results.) 

We can perform multiplicity-adjusted pointwise tests of each model coefficient at specific radii of interest (say we are interested in radii 50 and 100), using **pointwise_test().**  The output of this function gives the adjusted p-values of the tests, and the lower bound and upper bound of the pointwise confidence interval for each test. 

```{r }
p <- pointwise_test(data=sumfun.data, formula = outcome ~ 1, r.star = c(50,100),
                    re=c('patient_id'), alpha=.05, method = c('bonferroni'))
p

```

The last function we demonstrate here is **Ftest().**  Suppose we wish to test the significance of patient age and $\hat{L}_{Endo,TM}(r)$ (the L curve of T cells or macrophages around endothelial cells) simultaneously as predictors of $\hat{L}_{Endo,Pro}(r) - r$. We can run the wild bootstrap F test to jointly test these two covariates.

```{r }
spatialcov.data <- preprocess_data(data=breastcancer_data_subset_10images, from.cell=7, to.cell=16,
                               qc.cellcount.cutoff=20, P=50, perm.yn=T,
                               R=200, inc=1, image.dims=c(0,1000,0,1000),
                               summary.function='L',seed=456)
names(spatialcov.data)[names(spatialcov.data)=='L.obs'] <- 'spatial.cov'
spatialcov.data$L.expect <- spatialcov.data$L.pmean <- spatialcov.data$outcome <- NULL
sumfun.data.full <- merge(sumfun.data, spatialcov.data, by=c('image_number','r','patient_id','patient_age','tumor_grade'),all=T) 
sumfun.data.full$spatial.cov <- ifelse(is.na(sumfun.data.full$spatial.cov), 0, sumfun.data.full$spatial.cov)

formula.full <- outcome ~ patient_age + spatial.cov 
formula.red <- outcome ~ 1 

F.p.value <- Ftest(formula.full=formula.full, formula.red=formula.red,
                  data=sumfun.data.full, spatial.covars = c('spatial.cov'),
                  B=10,alpha=.05,seed=456)
F.p.value

```
On this small data subset with only 10 bootstrap samples, the joint test is highly significant.


## References









