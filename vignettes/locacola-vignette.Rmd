---
title: "Analyzing multiplex imaging data using functional regression"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{locacola-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

**Carly Middleton**

In this tutorial, we demonstrate the utilities of our package, Loca-Cola, for analyzing cell type colocalization in multiplex imaging data.  We apply functions from our package to two small subsets of 

**Installation**

```{r setup, error=FALSE, warning=FALSE, message=FALSE}
library(spatstat.data)
library(spatstat.univar)
library(spatstat.geom)
library(spatstat.random)
library(spatstat.explore)
library(refund)
library(dplyr)
library(phantem)

library(ggplot2)
library(patchwork)
#library(cowplot)
devtools::load_all()
```

** Disclaimer:  this tutorial simply demonstrates how to user our functions, and we do not claim it to be a full analysis of data by which biological conclusions should be drawn.  We take several shortcuts in this tutorial in order to save computation time while demonstrating how to use the package (e.g., small number of bootstrap samples, only 10 images worth of data, etc.) that should not be used during a full data analysis **

## Jackson Fischer Breast Cancer Data

First, we will analyze the Jackson Fischer breast cancer dataset.

```{r fig.width = 7, fig.height = 12}
data("breastcancer_data_subset")

pallete <- c('Other' = "gray", '7' = 'gold', '3' = "darkgreen", '9' = 'skyblue', '16'='cyan4')
plot.list <- plot_images(data = breastcancer_data_subset, images.to.plot = unique(breastcancer_data_subset$image_number), cell.types.to.plot=c(7,3,9,16), pallete=pallete)

(plot.list[[1]] + plot.list[[2]])/
(plot.list[[3]] + plot.list[[4]])/
(plot.list[[5]] + plot.list[[6]])/
(plot.list[[7]] + plot.list[[8]])/
(plot.list[[9]] + plot.list[[10]])

```


```{r }
sumfun.data <- preprocess_data(data=breastcancer_data_subset, from.cell=7, to.cell=3,
                               qc.cellcount.cutoff=20, P=50, perm.yn=T,
                               R=200, inc=1, image.dims=c(0,1200,0,1200),
                               summary.function='L',seed=456)

```


```{r fig.width = 6, fig.height = 3, eval=F,include=F}
p1 <- ggplot(data=sumfun.data ) + theme_bw() + 
  geom_point(aes(x=r, y=L.obs)) + xlim(0,200) +
  geom_line(aes(x = L.pmean, y = L.pmean, col='red'))

p2 <- ggplot(data=sumfun.data ) + theme_bw() + 
  geom_point(aes(x=L.pmean, y=L.obs)) + 
  geom_line(aes(x = L.pmean, y = L.pmean, col='red'))
#plot_grid(p1, p2, labels = "AUTO")
p1 + p2

```


```{r }
formula <- outcome ~ 1

pffrmodel <- fit_model(formula=formula, data=sumfun.data)
summary(pffrmodel)

```
```{r fig.width = 6, fig.height = 3}
CBs <- wildBS_CB(formula=formula, data=sumfun.data,re='patient_id',
                   B=10,alpha=.05,seed=456)
#Plot CBs
plot.wildBS_CB(CBs)

```
```{r }
p <- pointwise_test(data=sumfun.data, formula = formula, r.star = c(50,100),
                    re=c('patient_id'), alpha=.05, method = c('none'))
p

```
```{r }
p.adjusted <- pointwise_test(data=sumfun.data, formula = formula, r.star = c(50,100),
                             re=c('patient_id'), alpha=.05, method = c('bonferroni'))
p.adjusted

```


Now let's suppose that we want to test for 7/16 controlling for 3:6

```{r }
#calculate L_7,3:6
sumfun.data_macrophage <- preprocess_data(data=breastcancer_data_subset, from.cell=7, to.cell=4,
                               qc.cellcount.cutoff=20, P=50, perm.yn=T,
                               R=200, inc=1, image.dims=c(0,1200,0,1200),
                               summary.function='L',seed=456)

```

```{r , eval=F}
sumfun.data$grade2 <- ifelse(sumfun.data$tumor_grade=='2', 1, 0)
formula <- outcome ~ patient_age + grade2 

pffrmodel <- phantem::fit_model(formula=formula,
                      data=sumfun.data, 
                      patient.id='patient_id')
summary(pffrmodel)

CBs <- wildBS_CB(formula=formula, image.id='image_number',patient.id='patient_id',
                   data=sumfun.data,re='patient_id',
                   B=10,alpha=.05,seed=456)
#Plot CBs
plot.wildBS_CB(CBs)
```
















## Melanoma Data

Next, we will analyze a melanoma dataset that contains multiple images per patient.

Calculate permuted summary functions, plot the corrected outcomes:

```{r eval=F}
data("breastcancer_data_subset")

sumfun.data <- preprocess_data(data=melanoma_data_subset, from.cell="Macrophage", to.cell="CD8- T cell",
                      qc.cellcount.cutoff=20, P=50, perm.yn=T, cell.label = 'cell_type', image.id='image_number',
                       R=200, inc=1, image.dims=c(0,1200,0,1200), summary.function='g',seed=456)

sumfun.data$patient_id <- factor(sumfun.data$patient_id)
sumfun.data$patient_gender <- ifelse(sumfun.data$patient_gender=='f', 1, 0)
sumfun.data$patient_age <- ifelse(sumfun.data$patient_age=='<45', 0, 1)


```

Fit the model, specifying a random intercept for the patient:

```{r eval=F}
formula <- outcome ~ g.obs + patient_gender + patient_age + s(patient_id, bs='re')

pffrmodel <- fit_model(formula=formula,
                      data=sumfun.data, spatial.covars = c('g.obs'),
                      patient.id='patient_id')
summary(pffrmodel)

```

Spaghetti plot of the observed spatial summary function and its predicted value under the model. Also, plots of color coded images:

```{r }


```

Calculate and plot wild bootstrap confidence bands for each model coefficient:

```{r eval=F}
##Calculate CBs
CBs <- wildBS_CB(formula=formula, image.id='image_number',patient.id='patient_id',
                   data=sumfun.data, spatial.covars = c('g.obs'), re=c('patient_id'),
                   B=10,alpha=.05,seed=456)
#Plot CBs
plot.wildBS_CB(CBs)

```

Test for the joint significance of three points simultaneously, applying Bonferroni:

```{r eval=F}
##Adjust pointwise CIs for multiplicity
p.adjusted <- pointwise_test(data=sumfun.data, formula = formula, r.star = c(75,100,125), re=c('patient_id'),
                             patient.id=c('patient_id'),alpha=.05,image.id=c('image_number'),
                             spatial.covars = c('g.obs'),method = c('bonferroni'))
p.adjusted

```

Run the wild bootstrap F test to jointly test patient_age and g.obs:

```{r eval=F}
formula.full <- outcome ~ patient_gender + patient_age + g.obs + s(patient_id, bs='re')
formula.red <- outcome ~ patient_gender + s(patient_id, bs='re')

F.p.value <- Ftest(formula.full, formula.red,image.id='image_number',patient.id='patient_id',
                  data=sumfun.data, spatial.covars = c('g.obs'),
                  B=50,alpha=.05,re=c('patient_id'),seed=456)
F.p.value

```
